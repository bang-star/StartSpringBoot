# 4. 다양한 연관관계 처리

 - 관계형 데이터베이스에서 구조를 설계하는 작업이 가장 중요한 것처럼, JPA에서도 객체 간의 상호 연관관계를 처리하는 작업이 가장 중요하다.

  - 학습 내용

    - 객체간 연관관계 설정

    - 단방향, 양방향 관계의 이해

    - JPQL을 이용한 @Query 처리와 Fetch JOIN

## 4.1 연관관계 처리의 순서와 사전 설계

  - 객체와 객체와의 관계를 처리하는 연관관계의 가장 흔한 예는 '게시글과 댓글'의 관계라고 할 수 있다.

     1. 필요한 각각의 클래스를 정의한다.

     2. 각 클래스의 연관관계에 대한 설정을 추가한다.

        A. '일대다', '다대다' 등의 연관관계 설정

        B. 단방향, 양방향 설정

     3. 데이터베이스상에서 원하는 형태의 테이블이 만들어지는지 확인

     4. 테스트 코드를 통해 정상적으로 동작하는지 확인

  - JPA는 결과적으로 데이터베이스상에 테이블을 생성하기 때문에, 클래스상에 표현된 연관관계는 테이터베이스 테이블 간의 구조가 된다.

  - JPA를 이용하더라도 반드시 목적에 맞는 데이터베이스의 설계 능력은 필수이다.

### 4.1.1 관계형 데이터베이스의 설계와 JPA

 - 설계 순서

   1. 가장 중심이 되는 사람이나 명사를 결정, 이에 대한 구조를 대략적으로 설계

   2. 1번 과정에서 생성된 데이터들이 상호작용을 하면서 만들어내는 새로운 데이터를 정의

   3. 1번과 2번을 다시 세분화해서 설계

### 중심이 되는 데이터 결정

  - (예시)

    ```
    쇼핑몰에서 가장 중요한 데이터는 매출이다.

    매출이라는 데이터는 반드시 회원과 상품 데이터가 존재해야만 가능하다.

    최종적으로 원하는 데이터는 매출이지만
    이를 위해서 '회원'과 '상품'이라는 데이터는 반드시 필요하다.
    가장 중심이 되는 명사나 사람은 아무 사전 조건 없는 순수한 데이터가 된다.
    ```

    - 순수한 데이터의 특징

       - 순수한 장부의 형태로 존재

       - 중심이 되는 데이터는 독립적인 라이프사이클을 유지한다.

       - 고객의 요구사항에서 항상 몯든 행위의 주어나 목적어가 된다.

    - 순수한 중심 데이터를 결정했다면 이에 대한 'dummy 데이터'를 설계해 주는 것이 좋다.

        - 'dummy 데이터'는 말 그대로 아무 의미를 가지지 않은 가짜 데이터다.

        - 개발 과정에서 이러한 가짜 데이터를 활용해 설계의 적합성이나 타당성을 검토하게 된다.

        - 회원 데이터

           - 회원 ID : user00, user01, user02, user03 ...

           - 칼럼 ... : hong@... , lim@... , ...

        - 상품 데이터 

            - 상품 코드 : P1, P2, P3, P4 ... 
            
            - 칼럼... : 냉장고, 세탁기, TV, 노트북

     - 일반적으로 테이블을 설계할 때는 칼럼을 세로축에 작성하지만, 데이터들의 연관관계를 파악할 때에는 가로로 작성하는 형태가 편리하다.

### 중심 데이터 간의 상호 작용

  - 중심이 되는 데이터들이 주로 명사나 사람이었다면, 이 사이에 파생되는 데이터는 '동사'의 영역이다.

    - '동사'에는 주로 중심이 되는 데이터들의 동작과 히스토리가 기록된다.

       - '회원이 상품을 구매했다' 혹은 '회원의 상품 구매 히스토리'와 같이 처리된다.

    <img src="https://user-images.githubusercontent.com/63120360/182875239-4a9037ff-b2a3-4be9-aadd-0d33577024d0.png">

    ```
    '구매'는 '회원'과 '상품' 데이터가 존재하는 상태에서만 존재가 가능하다.
    ```

### 연관관계의 설정

  - 데이터베이스상에서의 연관관계를 설정하는 방법은 아주 단순하다.

  - '더미 데이터'를 이용해 테이블의 구조를 설계했다면 남은 일은 어떤 데이터가 얼마나 중복해서 나타나는가를 세는 것만으로도 모든 관계를 파악할 수 있다.

  <img src="https://user-images.githubusercontent.com/63120360/182877076-26532db5-7714-4c1e-b589-7886876b68e9.png">

<br />
  
  - 회원의 ID는 하나씩만 나타나므로 직선(one)으로 표현

  - 구매 쪽에서는 회원의 ID는 여러번 등장하였기 때문에 '갈퀴' 모양으로 표현

  - 전통적인 관계형 데이터베이스의 연관관계

     - 일대일(One To One 1:1)

     - 일대다(One To Many 1:N)

     - 다대다(Many To Many M:N)

  - 데이터베이스의 설계 그림을 ERD(Entity Relation Diagram)라고 한다.

  - 전통적인 개발 방식에서는 먼저 ERD를 그려서 데이터베이스의 설계를 작성하고, 테이블을 생성한후에 본격적인 개발에 들어가게 된다.

  - JPA에서의 연관관계

     - 일대일(@OneToOne)

     - 일대다(@OneToMany)

     - 다대일(@ManyToOne)

     - 다대다(@ManyToMany)

  - JPA를 이용하는 경우에 반드시 '방향'에 대한 설정이 필요하다.

    - 단뱡항(Unidirectional) 참조
       
       한쪽의 클래스만 다른 클래스의 인스턴스를 참조하도록 설정

    - 양방향(Bidirectional) 참조
       
       양쪽 클래스 모두 다른 클래스의 인스턴스를 참조

  - 관계형 데이터베이스와 비교해 보면 '일대다'의 관계가 '일대다'와 '다대일'의 관계로 세분화된 것을 볼 수 있는데, 이것은 객체지향이라는 것이 상대적인 입장에서 관계를 파악할 수 있기 때문이다.

     ```
     예를 들어
     한명의 회원은 상품을 여러 번 구매할 수 있으므로 '회원'과 구매'는 '일대다'의 관계가 성립한다.
     
     '구매'의 입장에서 보면 '구매는 회원에 의해서 이루어진다'고 할 수 있다.

     구매 입장에서 본 '회원'과 '구매'는 '다대일'의 관계가 성립된다.
     ```

     - JPA는 기존에 테이블 설계와 객체 설계를 하나로 합친 형태라 할 수 있다.

<br />

### 4.1.2 작성하려는 예제의 개요

  - 예제

     - 회원과 프로필 사진들의 관계(일대다, 다대일, 단방향)

     - 자료실과 첨부파일의 관계(일대다, 다대일, 단방향)

     - 게시물과 댓글의 관계(일대다, 다대일, 양방향)

  - 데이터베이스상에서는 동일한 관계이지만, JPA를 이용하는 경우에 상황에 따라 다른 방식의 접근이 필요하므로, 각 방식의 장점과 단점이 무엇인지를 파악할 필요가 있다.

    - 회원과 프로필(←)

    - 자료와 첨부파일(→)

    - 게시물과 댓글(↔)
